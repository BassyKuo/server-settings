#!/bin/bash

#----------------------------------------------------------------
###             FOR ROOT ADMINISTRATOR EXECUTING              ###
#----------------------------------------------------------------
# Install:
#	python-scipy python-dev python-pip python-nose gcc g++
#	libopenblas-dev git vim git-core openssh-server
#
# Pip install:
#	virtualenv
#
# General Setting:
#	First-matching History Command Bind-key > /etc/bash.bashrc
#	selected_editor="/usr/bin/vim.basic" > /root/.selected_editor
#
# Setting:
#	Git-server
#	SSH
#	crontab
#
# Add File:
#	.bashrc
#	.vimrc
#	git-repository
#	git-members
#
### Written by Bassy<aaammmyyy27@gmail.com> 2016/7/12 v2.4.5

test "$USER" = "root" || exit 0

# Insatll
sudo apt-get update
sudo apt-get install python-numpy 
if [ $? -eq 100 ]; then
	sudo mv /var/cache/apt/archives/lock /var/cache/apt/archives/lock_bak
	sudo apt-get install python-numpy 
fi
sudo apt-get install python-scipy python-dev python-pip python-nose gcc g++ libopenblas-dev git vim git-core openssh-server

# Pip install
sudo pip install virtualenv

# General Setting
#groupadd ELSA

grep "Search First-matching History Command" /etc/bash.bashrc > /dev/null 2>&1
if [ $? -ne 0 ]; then
	echo -e "\n# Search First-matching History Command" >> /etc/bash.bashrc
	echo "bind '\"\\x1b\\x5b\\x41\":history-search-backward'" >> /etc/bash.bashrc
	echo "bind '\"\\x1b\\x5b\\x42\":history-search-forward'" >> /etc/bash.bashrc
fi

# `select-editor`
echo -e "\
# Generated by /usr/bin/select-editor \n\
SELECTED_EDITOR=\"/usr/bin/vim.basic\"" > /root/.selected_editor

# Git-server setting
## Git Config Setting
sudo git config --system core.editor vim
sudo git config --system merge.tool vimdiff
sudo git config --system color.status auto
sudo git config --system color.branch auto
sudo git config --system color.interactive auto
sudo git config --system color.diff auto
sudo git config --system color.ui true

## Create 'git' group
test `getent group git` || groupadd git
sudo grpconv

## Create /var/git/
if [ -d "/var/git" ]; then :
else
	sudo mkdir /var/git
	sudo chgrp git /var/git
	sudo chmod g+rwx /var/git
fi
echo "Git-server set completely."

# SSH setting
grep "AllowGroups ELSA" /etc/ssh/sshd_config > /dev/null 2>&1
if [ $? -ne 0 ]; then
	echo "AllowGroups ELSA" >> /etc/ssh/sshd_config
fi
grep "AllowGroups git" /etc/ssh/sshd_config > /dev/null 2>&1
if [ $? -ne 0 ]; then
	echo "AllowGroups git" >> /etc/ssh/sshd_config
fi
## Also, have to change 'PermitRootLogin no' 
sudo service ssh restart
echo "SSH set completely."

# Crontab setting
#	to backup /home/ and /var/git/ every day
#cronday=( fname1 fname2 fname3 )
#cronweek=( fname1 fname2 fname3 )
#for FILE in ${cronday[*]}; do
#	cp -p doc/cron/daily/$FILE /etc/cron.daily/$FILE && chmod 755 $FILE
#done
#for FILE in ${cronweek[*]}; do
#	cp -p doc/cron/week/$FILE /etc/cron.weekly/$FILE && chmod 755 $FILE
#done

#	   m h dom mon dow user	command
grep "tar -zcf /var/backups/home.tgz /home/" /etc/crontab > /dev/null 2>&1
if [ $? -ne 0 ]; then
	echo "00 4	* * 2	root	tar -zcf /var/backups/home.tgz /home/" \
	>> /etc/crontab
fi
grep "tar -zcf /var/backups/git.tgz /var/git/" /etc/crontab > /dev/null 2>&1
if [ $? -ne 0 ]; then
	echo "00 4	* * 2	root	tar -zcf /var/backups/git.tgz /var/git/" \
	>> /etc/crontab
fi
sudo service cron restart
echo "Crontable set completely."

# Add File
cp -p rc/.bashrc /root/.bashrc
#cp -p rc/.bash_profile /root/.bash_profile
cp -p rc/.vimrc /root/.vimrc
echo "Install git-repository"
cp -p bin/git-repository /usr/bin/git-repository # create/url/list
chmod 755 /usr/bin/git-repository
echo "Install git-members"
cp -p bin/git-members /usr/bin/git-members # add/remove/list
chmod 755 /usr/bin/git-members

# Done
echo "Done!"
